<!-- Chat Box Toggle Button (Fixed Position) -->
<button type="button" class="btn btn-primary rounded-circle shadow-lg chat-toggle-btn" data-bs-toggle="offcanvas" data-bs-target="#chatOffcanvas" aria-controls="chatOffcanvas">
    <i class="bi bi-chat-dots"></i>
</button>

<!-- Chat Box Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="chatOffcanvas" aria-labelledby="chatOffcanvasLabel" style="width: 400px;">
    <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title" id="chatOffcanvasLabel">
            <i class="bi bi-robot me-2"></i>
            AI Assistant Chat
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    
    <div class="offcanvas-body d-flex flex-column p-0">
        <!-- Chat History -->
        <div id="chat-history" class="flex-grow-1 overflow-auto p-3 bg-light">
            <div class="text-muted text-center py-3">
                <i class="bi bi-chat-square-text" style="font-size: 2rem;"></i>
                <p class="mt-2">Start a conversation</p>
            </div>
        </div>
        
        <!-- Chat Input Form -->
        <div class="border-top bg-white p-3">
            <form id="chat-form">
                <div class="mb-2">
                    <select id="assistant-selector" class="form-select form-select-sm">
                        <option value="text-davinci-003">OpenAI Davinci</option>
                        <!-- Add more assistants as options here -->
                    </select>
                </div>
                <div class="input-group">
                    <input type="text" id="chat-input" class="form-control" placeholder="Type a message..." aria-label="Chat message">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
    .chat-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        z-index: 1040;
    }
    
    .chat-message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
    }
    
    .chat-message.user {
        background-color: #0d6efd;
        color: white;
        margin-left: 2rem;
    }
    
    .chat-message.assistant {
        background-color: #e9ecef;
        color: #212529;
        margin-right: 2rem;
    }
    
    #chat-history:empty::after {
        content: "No messages yet";
        display: block;
        text-align: center;
        color: #6c757d;
        padding: 2rem;
    }
</style>

<!-- Chat Functionality -->
<script>
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const inputField = document.getElementById('chat-input');
        const message = inputField.value.trim();
        const assistant = document.getElementById('assistant-selector').value;
        
        if (message) {
            // Append user message to chat history
            const chatHistory = document.getElementById('chat-history');
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = `<strong>You:</strong><br>${message}`;
            chatHistory.appendChild(userMessage);
            
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Clear input field
            inputField.value = '';
            
            // TODO: Send `message` and `assistant` to your backend and handle the response
            // Example AJAX call:
            /*
            fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: message,
                    assistant: assistant
                })
            })
            .then(response => response.json())
            .then(data => {
                const assistantMessage = document.createElement('div');
                assistantMessage.className = 'chat-message assistant';
                assistantMessage.innerHTML = `<strong>Assistant:</strong><br>${data.response}`;
                chatHistory.appendChild(assistantMessage);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            });
            */
        }
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>