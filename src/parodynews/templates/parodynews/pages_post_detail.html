{% extends "base.html" %}
{% load custom_filters %}
{% load martortags %}
{% load markdownify %}
{% load django_bootstrap5 %}
{% load static %}

{% block css %}
{% endblock %}

{% block content %}

{% comment %} 
TODO: Add image uploading capability for posts.
TODO: Add better error handling and user feedback for actions (e.g., saving, deleting, publishing).
TODO: Add content types and sub-types for publication SEO
TODO: Add document comparison tool for assistant comparison
TODO: Add document comparison tool for version control
TODO: Update the assistant field with last assistant to produce output

{% endcomment %}

{% if post.id %}
<div class="container">
    <h2><i class="bi bi-file-earmark-text"></i> Editing: {{ post.id }}</h2>
    <form method="post" action="{% url 'manage_post' %}" class="needs-validation" novalidate>
        {% csrf_token %}
        {% bootstrap_form form_post_frontmatter %}
        {% bootstrap_form form_post %}
    </form>

    <!-- Action Buttons (outside main form to avoid nesting) -->
    <div class="d-grid gap-2 mt-3">
        <!-- Save Button Form -->
        <form action="{% url 'edit_post' post.id %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <input type="hidden" name="_method" value="save">
            <input type="hidden" name="action" value="save">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-save"></i> Save
            </button>
        </form>
        <!-- Delete Button Form -->
        <form action="{% url 'delete_post' post.id %}" method="POST" class="delete-form">
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <input type="hidden" name="_method" value="delete">
            <input type="hidden" name="action" value="delete">
            <button type="button" class="btn btn-danger w-100 delete-btn"
                    data-bs-toggle="modal" 
                    data-bs-target="#confirmModal"
                    data-confirm-message="Are you sure you want to delete this post? This action cannot be undone.">
                <i class="bi bi-trash"></i> Delete
            </button>
        </form>
        <!-- Publish Button Form -->
        <form action="{% url 'publish_post' post.id %}" method="POST" data-loading>
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <input type="hidden" name="_method" value="publish">
            <input type="hidden" name="action" value="publish">
            <button type="submit" class="btn btn-success w-100" data-loading-text="Publishing...">
                <i class="bi bi-cloud-upload"></i> Publish to GitHub
            </button>
        </form>
    </div>

{% endif %}

{% if github_url %}
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert" data-auto-dismiss="10000">
        <strong>Success!</strong> Your post has been published. 
        <a href="{{ github_url }}" class="alert-link" target="_blank" rel="noopener noreferrer">
            Review it on GitHub <i class="bi bi-box-arrow-up-right"></i>
        </a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}

    <!-- Post Content Preview -->
    <div class="post-content mt-4">
        <h3>Post Preview</h3>
        <div class="card">
            <div class="card-body">
                {% if post.post_content %}
                    {{ post.post_content|markdownify|safe }}
                {% else %}
                    <p class="text-muted">No content available</p>
                {% endif %}
            </div>
        </div>
    </div>


<!-- Post List -->
<div class="container mt-5">
    <h2>Post List</h2>
    {% render_model_table post_list fields display_fields 'post_detail' 'Published Posts' %}
</div>
    
{% endblock content %}
